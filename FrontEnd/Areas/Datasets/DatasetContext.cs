using System.Data;
using Microsoft.Extensions.Configuration;
using Dapper;
using ScadaCommon;
using Npgsql;

namespace FrontEnd.Areas.Datasets
{
    public class DatasetContext
    {
        private const string TableArchetype = @"(""Id"" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
            ""ClientId"" integer NOT NULL,
            ""Timestamp"" timestamp NOT NULL,
            ""RegisterType"" integer NOT NULL,
            ""RegisterAddress"" integer NOT NULL,
            ""Value"" integer NOT NULL,
            PRIMARY KEY(""Id"")
            );";

        public static string GetTableName(Organization organization)
        {
            return ("public.org_" + organization.OrganizationId + "_data");
        }

        public void CreateNewTable(Organization organization)
        {
            using IDbConnection db = new NpgsqlConnection(Startup.Configuration.GetConnectionString("UserContextConnection"));
            db.Execute("CREATE TABLE IF NOT EXISTS " + GetTableName(organization) + TableArchetype);
        }

        public void RemoveTable(Organization organization)
        {
            using IDbConnection db = new NpgsqlConnection(Startup.Configuration.GetConnectionString("UserContextConnection"));
            db.Execute("Drop Table IF EXISTS " + GetTableName(organization));
        }
    }
}
