@page "/organizations/manage/{organizationId:int}"

@using FrontEnd.Areas.Organizations.Data;
@using FrontEnd.DataModels;

@inject NavigationManager NavManager
@inject OrganizationContext OrganizationContext
@inject AuthenticationStateProvider authState

@attribute [Authorize]

<h3 class="text-center">ManageOrganization - @m_organizationName </h3>

<div class="container" style="max-width:500px">
    <div class="border" style="padding: 20px; margin: 10px">
        <h4 class="text-center">Info</h4>
        <EditForm Model="@OrganizationRegistration" OnSubmit="ChangeOrganizationName">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="organization name"><b>Nazwa organizacji</b></label>
                <InputText id="username" @bind-Value="OrganizationRegistration.OrganizationName" class="form-control" required
                           placeholder="Nazwa organizacji..." />
            </div>
            @m_nameChangeError
            <button class="btn btn-primary" type="submit">Zmień nazwę</button>

        </EditForm>

    </div>
</div>
<br />

<div class="container" style="max-width:500px">
    <div class="border overflow-auto" style="padding:20px;margin:10px">
        <h4 class="text-center">Konfiguracje</h4>
        <table>
            <tbody>
                @foreach (ClientConfigEntity config in m_organizationConfigs)
                {
                    <tr>
                        <td><a class="oi oi-share-boxed" href=@String.Concat("/configurations/edit/",config.ID) /></td>
                        <td>@config.ConfigName</td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="text-center">
            <a class="btn btn-success" href=@String.Concat("/configurations/create/",OrganizationId)>➕ Stwórz nową konfiguracje</a>
        </div>
    </div>
</div>

<div class="container" style="max-width:500px">
    <div class="border overflow-auto" style="padding:20px;margin:10px">
        <h4 class="text-center">Usuń organizacje</h4>
        <div class="text-center">
            <button type="button" class="btn btn-danger" @onclick="() => DeleteOrganization()">
                ❗ 🗙 Usuń organizacje ❗
            </button>
        </div>
    </div>
</div>


@code {
    [Parameter]
    public int OrganizationId { get; set; }

    public OrganizationRegistrationModel OrganizationRegistration { get; set; } = new OrganizationRegistrationModel();

    private string m_organizationName;
    private string m_nameChangeError;
    private List<ClientConfigEntity> m_organizationConfigs;

    protected override Task OnInitializedAsync()
    {
        InitParams();
        return base.OnInitializedAsync();
    }

    protected override Task OnParametersSetAsync()
    {
        InitParams();
        return base.OnParametersSetAsync();
    }

    private void InitParams()
    {
        m_organizationName = OrganizationContext.Organizations
            .Where(x => x.OrganizationId == OrganizationId)
            .Select(x => x.Name)
            .FirstOrDefault();
        OrganizationRegistration.OrganizationName = m_organizationName;
        m_organizationConfigs = OrganizationContext.Configurations
            .Where(x => x.OrganizationId == OrganizationId).ToList();
    }

    private void ChangeOrganizationName()
    {
        if (OrganizationRegistration.OrganizationName.Trim() == m_organizationName.Trim())
            m_nameChangeError = "Nazwa jest taka sama!";
        else if (OrganizationContext.Organizations.Any(x => x.Name == OrganizationRegistration.OrganizationName.Trim()))
            m_nameChangeError = "Inna organizacja ma już taką samą nazwe!";
        else
        {
            OrganizationContext.Organizations
                .Where(x => x.OrganizationId == OrganizationId)
                .FirstOrDefault().Name = OrganizationRegistration.OrganizationName.Trim();
            OrganizationContext.SaveChanges();
            OnInitializedAsync().Wait();
            m_nameChangeError = String.Empty;
        }
    }

    private void DeleteOrganization()
    {
        var organization = OrganizationContext.Organizations.Where(x => x.OrganizationId == OrganizationId).FirstOrDefault();
        OrganizationContext.Organizations.Remove(organization);
        OrganizationContext.Configurations
            .Where(x => x.OrganizationId == OrganizationId)
            .ToList()
            .ForEach((y) => OrganizationContext.Configurations.Remove(y));
        OrganizationContext.SaveChanges();
        NavManager.NavigateTo("/Account/Organizations",true);
    }

}
